# This workflow integrates ShiftLeft NG SAST with GitHub
# Visit https://docs.shiftleft.io for help
name: ShiftLeft

on:
  pull_request:
  workflow_dispatch:
  push:
    # We recommend triggering a scan when merging to your default branch as a best practice,
    # especially if you'd like to compare the results of two scans (e.g., a feature branch against the
    # default branch)
    branches:
      - main
      - master
      - 'emnet/*'

jobs: 
  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: Install bazelisk
        run: |
          curl -LO "https://github.com/bazelbuild/bazelisk/releases/download/v1.1.0/bazelisk-linux-amd64"
          mkdir -p "${GITHUB_WORKSPACE}/bin/"
          mv bazelisk-linux-amd64 "${GITHUB_WORKSPACE}/bin/bazel"
          chmod +x "${GITHUB_WORKSPACE}/bin/bazel"

      - name: Install ShiftLeft CLI
        run: |
          curl https://cdn.shiftleft.io/download/sl > ${GITHUB_WORKSPACE}/sl && chmod a+rx ${GITHUB_WORKSPACE}/sl

      - name: Setup bazel
        run: |
          echo "build --config nolintonbuild" >> ${GITHUB_WORKSPACE}/.bazelrc.user && \
          echo "build --config=dev" >> ${GITHUB_WORKSPACE}/.bazelrc.user && \
          echo "build --disk_cache=~/.cache/bazel" >> ${GITHUB_WORKSPACE}/.bazelrc

      # Caches and restores the bazelisk download directory, the bazel build directory.
      - name: Cache bazel
        uses: actions/cache@v2.1.4
        env:
          cache-name: bazel-cache
        with:
          path: |
            ~/.cache/bazelisk
            ~/.cache/bazel
          key: ${{ runner.os }}-${{ env.cache-name }}


      - name: Build cockroach binary
        run: |
          bazel build pkg/cmd/cockroach-short

      - name: Run scan
        run: |
          ${GITHUB_WORKSPACE}/sl analyze --app cockroach --go --cpg .
        env:
          SHIFTLEFT_ACCESS_TOKEN: ${{ secrets.SHIFTLEFT_ACCESS_TOKEN }}
